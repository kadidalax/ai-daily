<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI Daily - ç®¡ç†åå°</title>
  <style>
* { margin: 0; padding: 0; box-sizing: border-box; }
/* è‡ªå®šä¹‰æ»šåŠ¨æ¡ */
::-webkit-scrollbar { width: 8px; height: 8px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: #444; border-radius: 4px; }
::-webkit-scrollbar-thumb:hover { background: #555; }
::-webkit-scrollbar-corner { background: transparent; }
/* Firefox */
* { scrollbar-width: thin; scrollbar-color: #444 transparent; }
:root {
  --bg-primary: #0f0f0f;
  --bg-secondary: #1a1a1a;
  --bg-tertiary: #252525;
  --border-color: #333;
  --text-primary: #e0e0e0;
  --text-secondary: #999;
  --accent: #4f9eff;
  --accent-hover: #3a8aee;
  --success: #4caf50;
  --danger: #f44336;
  --warning: #ff9800;
  --sidebar-width: 220px;
  --content-max-width: 900px;
}
html, body { height: 100%; }
body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  background: linear-gradient(135deg, #0a0a0a 0%, #121218 100%);
  color: var(--text-primary);
  display: flex;
  justify-content: center;
  align-items: flex-start;
  padding: 20px;
  min-height: 100vh;
}
.app-container {
  display: flex;
  width: 100%;
  max-width: calc(var(--sidebar-width) + var(--content-max-width) + 40px);
  min-height: calc(100vh - 40px);
  background: var(--bg-primary);
  border-radius: 12px;
  border: 1px solid var(--border-color);
  overflow: hidden;
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
}
.sidebar {
  width: var(--sidebar-width);
  background: var(--bg-secondary);
  border-right: 1px solid var(--border-color);
  padding: 20px 0;
  flex-shrink: 0;
  display: flex;
  flex-direction: column;
  position: sticky;
  top: 0;
  height: calc(100vh - 40px);
  overflow-y: auto;
}
.sidebar-header {
  padding: 10px 20px 20px;
  border-bottom: 1px solid var(--border-color);
  margin-bottom: 10px;
}
.sidebar-header h1 { font-size: 1.4rem; color: var(--accent); }
.sidebar-header p { font-size: 0.8rem; color: var(--text-secondary); margin-top: 4px; }
.nav-list { flex: 1; display: flex; flex-direction: column; }
.nav-item {
  display: flex;
  align-items: center;
  padding: 12px 20px;
  color: var(--text-secondary);
  cursor: pointer;
  transition: all 0.2s;
  border-left: 3px solid transparent;
}
.nav-item:hover { background: var(--bg-tertiary); color: var(--text-primary); }
.nav-item.active { background: var(--bg-tertiary); color: var(--accent); border-left-color: var(--accent); }
.nav-item span.icon { margin-right: 12px; font-size: 1.1rem; }
.nav-item.logout { color: var(--danger); margin-top: auto; border-top: 1px solid var(--border-color); padding-top: 16px; }
.main-content {
  flex: 1;
  padding: 30px 40px;
  max-width: var(--content-max-width);
  overflow-y: auto;
  height: calc(100vh - 40px);
}
.section { display: none; }
.section.active { display: block; }
.section-title { font-size: 1.5rem; margin-bottom: 8px; color: var(--text-primary); }
.section-desc { color: var(--text-secondary); margin-bottom: 24px; font-size: 0.9rem; }
.form-group { margin-bottom: 20px; }
.form-group label { display: block; margin-bottom: 6px; color: var(--text-secondary); font-size: 0.9rem; }
.form-row { display: flex; gap: 12px; align-items: flex-end; }
.form-row .form-group { flex: 1; margin-bottom: 0; }
.hint { color: var(--text-secondary); font-size: 0.85rem; margin-top: 4px; display: block; }
input[type="text"], input[type="password"], input[type="number"], select {
  width: 100%;
  padding: 10px 14px;
  background: var(--bg-tertiary);
  border: 1px solid var(--border-color);
  border-radius: 6px;
  color: var(--text-primary);
  font-size: 0.95rem;
  transition: border-color 0.2s;
}
input:focus, select:focus { outline: none; border-color: var(--accent); }
input::placeholder { color: var(--text-secondary); }
.btn {
  padding: 10px 20px;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  font-size: 0.9rem;
  font-weight: 500;
  transition: all 0.2s;
  display: inline-flex;
  align-items: center;
  gap: 6px;
}
.btn-primary { background: var(--accent); color: #fff; }
.btn-primary:hover { background: var(--accent-hover); }
.btn-secondary { background: var(--bg-tertiary); color: var(--text-primary); border: 1px solid var(--border-color); }
.btn-secondary:hover { border-color: var(--accent); }
.btn-success { background: var(--success); color: #fff; }
.btn-danger { background: var(--danger); color: #fff; }
.btn-sm { padding: 6px 12px; font-size: 0.85rem; }
.btn:disabled { opacity: 0.5; cursor: not-allowed; }
.card-actions { display: flex; gap: 10px; margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border-color); }
.card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; flex-wrap: wrap; gap: 10px; }
.card-header .card-title { margin-bottom: 0; }
.card-header-actions { display: flex; gap: 8px; flex-wrap: wrap; }
.input-with-hint { position: relative; }
.api-key-hint { position: absolute; right: 12px; top: 50%; transform: translateY(-50%); color: var(--text-secondary); font-size: 0.8rem; pointer-events: none; }
.switch-row {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 14px 0;
  border-bottom: 1px solid var(--border-color);
}
.switch-row:last-child { border-bottom: none; }
.switch-info h4 { font-size: 0.95rem; margin-bottom: 2px; }
.switch-info p { font-size: 0.8rem; color: var(--text-secondary); }
.switch { position: relative; width: 48px; height: 26px; }
.switch input { opacity: 0; width: 0; height: 0; }
.slider {
  position: absolute;
  cursor: pointer;
  inset: 0;
  background: var(--bg-tertiary);
  border-radius: 26px;
  transition: 0.3s;
  border: 1px solid var(--border-color);
}
.slider:before {
  content: "";
  position: absolute;
  height: 18px;
  width: 18px;
  left: 3px;
  bottom: 3px;
  background: #fff;
  border-radius: 50%;
  transition: 0.3s;
}
input:checked + .slider { background: var(--accent); border-color: var(--accent); }
input:checked + .slider:before { transform: translateX(22px); }
/* RSS å·¥å…·æ  */
.rss-toolbar {
  display: flex;
  gap: 16px;
  margin-bottom: 16px;
  flex-wrap: wrap;
  align-items: center;
}
.rss-search { flex: 1; min-width: 200px; }
.rss-search input { width: 100%; }
.rss-batch-actions {
  display: flex;
  gap: 8px;
  align-items: center;
  flex-wrap: wrap;
}
.batch-select-all {
  display: flex;
  align-items: center;
  gap: 6px;
  cursor: pointer;
  padding: 6px 12px;
  background: var(--bg-tertiary);
  border-radius: 6px;
  font-size: 0.85rem;
}
.batch-select-all input { width: 16px; height: 16px; cursor: pointer; }
/* RSS åˆ—è¡¨ */
.rss-list {
  background: var(--bg-secondary);
  border-radius: 8px;
  border: 1px solid var(--border-color);
  overflow: hidden;
  max-height: 500px;
  overflow-y: auto;
}
.rss-item {
  display: flex;
  align-items: center;
  padding: 10px 16px;
  border-bottom: 1px solid var(--border-color);
  gap: 10px;
}
.rss-item:last-child { border-bottom: none; }
.rss-item.selected { background: rgba(79, 158, 255, 0.1); }
.rss-item .rss-checkbox { flex-shrink: 0; width: 18px; height: 18px; cursor: pointer; }
.rss-item .switch { flex-shrink: 0; }
.rss-info { flex: 1; min-width: 0; }
.rss-info .source { font-weight: 500; margin-bottom: 2px; font-size: 0.9rem; }
.rss-info .url { font-size: 0.75rem; color: var(--text-secondary); word-break: break-all; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.rss-actions { display: flex; gap: 6px; flex-shrink: 0; }
/* RSS åˆ†é¡µ */
.rss-pagination {
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 8px;
  margin-top: 16px;
  flex-wrap: wrap;
}
.rss-pagination button {
  padding: 6px 12px;
  background: var(--bg-tertiary);
  border: 1px solid var(--border-color);
  border-radius: 4px;
  color: var(--text-primary);
  cursor: pointer;
  font-size: 0.85rem;
}
.rss-pagination button:hover { border-color: var(--accent); }
.rss-pagination button.active { background: var(--accent); border-color: var(--accent); }
.rss-pagination button:disabled { opacity: 0.5; cursor: not-allowed; }
.rss-pagination .page-info { color: var(--text-secondary); font-size: 0.85rem; }
.rss-status { color: var(--text-secondary); font-size: 0.85rem; margin-left: auto; }
.add-rss-form { display: flex; gap: 12px; margin-bottom: 16px; }
.add-rss-form input { flex: 1; }
.card {
  background: var(--bg-secondary);
  border: 1px solid var(--border-color);
  border-radius: 8px;
  padding: 20px;
  margin-bottom: 20px;
}
.card-title {
  font-size: 1rem;
  margin-bottom: 16px;
  padding-bottom: 12px;
  border-bottom: 1px solid var(--border-color);
}
.warning-card {
  background: rgba(255,152,0,0.1);
  border-color: var(--warning);
  margin-top: 20px;
}
.warning-card p { color: var(--warning); font-size: 0.9rem; }
.badge { display: inline-block; padding: 4px 10px; border-radius: 4px; font-size: 0.8rem; font-weight: 500; }
.badge-success { background: rgba(76,175,80,0.2); color: var(--success); }
.badge-warning { background: rgba(255,152,0,0.2); color: var(--warning); }
.badge-danger { background: rgba(244,67,54,0.2); color: var(--danger); }
.toast {
  position: fixed;
  top: 20px;
  right: 20px;
  padding: 14px 20px;
  background: var(--bg-secondary);
  border: 1px solid var(--border-color);
  border-radius: 8px;
  z-index: 1000;
  animation: slideIn 0.3s ease;
  max-width: 360px;
}
.toast.success { border-color: var(--success); }
.toast.error { border-color: var(--danger); }
@keyframes slideIn {
  from { transform: translateX(100%); opacity: 0; }
  to { transform: translateX(0); opacity: 1; }
}
/* æ¨¡æ€æ¡† */
.modal-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.6);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 1000;
  opacity: 0;
  visibility: hidden;
  transition: all 0.2s;
}
.modal-overlay.active {
  opacity: 1;
  visibility: visible;
}
.modal {
  background: var(--bg-secondary);
  border-radius: 12px;
  padding: 24px;
  width: 90%;
  max-width: 450px;
  transform: scale(0.9);
  transition: transform 0.2s;
}
.modal-overlay.active .modal {
  transform: scale(1);
}
.modal-title {
  font-size: 1.2rem;
  font-weight: 600;
  margin-bottom: 20px;
}
.modal-actions {
  display: flex;
  gap: 10px;
  justify-content: flex-end;
  margin-top: 20px;
}
.action-bar {
  display: flex;
  gap: 12px;
  margin-top: 24px;
  padding-top: 20px;
  border-top: 1px solid var(--border-color);
}
.history-item { padding: 14px 0; border-bottom: 1px solid var(--border-color); }
.history-item:last-child { border-bottom: none; }
.history-header { display: flex; justify-content: space-between; margin-bottom: 8px; }
.history-date { font-weight: 500; }
.history-articles { font-size: 0.85rem; color: var(--text-secondary); }
.history-articles li { margin: 4px 0; }
@media (max-width: 768px) {
  .app-container { flex-direction: column; }
  .sidebar {
    width: 100%;
    height: auto;
    position: relative;
    padding: 10px;
  }
  .sidebar-header { width: 100%; padding: 10px; border-bottom: none; margin-bottom: 0; }
  .nav-list { flex-direction: row; flex-wrap: wrap; }
  .nav-item { padding: 8px 12px; border-left: none; border-bottom: 2px solid transparent; font-size: 0.85rem; }
  .nav-item.active { border-left-color: transparent; border-bottom-color: var(--accent); }
  .nav-item.logout { margin-top: 0; border-top: none; }
  .main-content { padding: 20px; }
  .form-row { flex-direction: column; }
  .add-rss-form { flex-direction: column; }
}
  </style>
</head>
<body>
  <div class="app-container">
    <nav class="sidebar">
      <div class="sidebar-header">
        <h1>ğŸ“° AI Daily</h1>
        <p>ç®¡ç†åå°</p>
      </div>
      <div class="nav-list">
        <div class="nav-item active" data-section="llm">
          <span class="icon">ğŸ¤–</span> LLM è®¾ç½®
        </div>
        <div class="nav-item" data-section="rss">
          <span class="icon">ğŸ“¡</span> RSS æº
        </div>
        <div class="nav-item" data-section="digest">
          <span class="icon">âš™ï¸</span> æ‘˜è¦è®¾ç½®
        </div>
        <div class="nav-item" data-section="telegram">
          <span class="icon">ğŸ“±</span> Telegram
        </div>
        <div class="nav-item" data-section="schedule">
          <span class="icon">â°</span> å®šæ—¶ä»»åŠ¡
        </div>
        <div class="nav-item" data-section="history">
          <span class="icon">ğŸ“Š</span> è¿è¡Œå†å²
        </div>
        <div class="nav-item" data-section="logs">
          <span class="icon">ğŸ“‹</span> ç³»ç»Ÿæ—¥å¿—
        </div>
        <div class="nav-item" data-section="account">
          <span class="icon">ğŸ”</span> è´¦å·è®¾ç½®
        </div>
        <div class="nav-item logout" onclick="logout()">
          <span class="icon">ğŸšª</span> é€€å‡ºç™»å½•
        </div>
      </div>
    </nav>

    <main class="main-content">
      <!-- LLM è®¾ç½® -->
      <section id="sec-llm" class="section active">
        <h2 class="section-title">LLM è®¾ç½®</h2>
        <p class="section-desc">é…ç½®å¤§è¯­è¨€æ¨¡å‹ APIï¼Œæ”¯æŒ OpenAI å…¼å®¹æ ¼å¼</p>
        
        <div class="card">
          <div class="card-header">
            <div class="card-title">ğŸ¤– ä¸» LLMï¼ˆå¿…å¡«ï¼‰</div>
            <div class="card-header-actions">
              <button class="btn btn-secondary btn-sm" onclick="testSingleLLM('primary')">ğŸ§ª æµ‹è¯•</button>
              <button class="btn btn-primary btn-sm" onclick="saveLLM('primary')">ğŸ’¾ ä¿å­˜</button>
            </div>
          </div>
          <div class="form-group">
            <label>API Base URL</label>
            <input type="text" id="llm-baseUrl" placeholder="https://api.openai.com/v1">
            <small class="hint">æ”¯æŒä»»ä½• OpenAI å…¼å®¹ API</small>
          </div>
          <div class="form-group">
            <label>API Key</label>
            <div class="input-with-hint">
              <input type="password" id="llm-apiKey" placeholder="sk-...">
              <small class="api-key-hint" id="llm-apiKey-hint"></small>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>æ¨¡å‹</label>
              <select id="llm-model"><option value="">ç‚¹å‡»è·å–æ¨¡å‹åˆ—è¡¨</option></select>
            </div>
            <button class="btn btn-secondary btn-sm" onclick="fetchModels('primary')">ğŸ”„ è·å–æ¨¡å‹</button>
          </div>
        </div>
        
        <div class="card">
          <div class="card-header">
            <div class="card-title">ğŸ”„ å¤‡ç”¨ LLMï¼ˆå¯é€‰ï¼‰</div>
            <div class="card-header-actions">
              <button class="btn btn-secondary btn-sm" onclick="testSingleLLM('backup')">ğŸ§ª æµ‹è¯•</button>
              <button class="btn btn-primary btn-sm" onclick="saveLLM('backup')">ğŸ’¾ ä¿å­˜</button>
            </div>
          </div>
          <p class="hint" style="margin-bottom:16px">å½“ä¸» LLM è¯·æ±‚å¤±è´¥æ—¶ï¼Œè‡ªåŠ¨åˆ‡æ¢åˆ°å¤‡ç”¨ LLM</p>
          <div class="form-group">
            <label>API Base URL</label>
            <input type="text" id="llm-backup-baseUrl" placeholder="https://api.deepseek.com/v1">
          </div>
          <div class="form-group">
            <label>API Key</label>
            <div class="input-with-hint">
              <input type="password" id="llm-backup-apiKey" placeholder="sk-...">
              <small class="api-key-hint" id="llm-backup-apiKey-hint"></small>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>æ¨¡å‹</label>
              <select id="llm-backup-model"><option value="">ç‚¹å‡»è·å–æ¨¡å‹åˆ—è¡¨</option></select>
            </div>
            <button class="btn btn-secondary btn-sm" onclick="fetchModels('backup')">ğŸ”„ è·å–æ¨¡å‹</button>
          </div>
        </div>
        
        <div class="card">
          <div class="card-title">âš™ï¸ é«˜çº§è®¾ç½®</div>
          <div class="form-row">
            <div class="form-group">
              <label>è¯·æ±‚è¶…æ—¶ï¼ˆç§’ï¼‰</label>
              <input type="number" id="llm-timeout" value="120" min="10" max="300">
            </div>
            <div class="form-group">
              <label>å¤±è´¥é‡è¯•æ¬¡æ•°</label>
              <input type="number" id="llm-maxRetries" value="2" min="0" max="5">
            </div>
          </div>
          <div class="switch-row" style="border-bottom:none;padding-top:8px">
            <div class="switch-info">
              <h4>ä¸» LLM å¤±è´¥æ—¶ä½¿ç”¨å¤‡ç”¨</h4>
              <p>å¯ç”¨åï¼Œå½“ä¸» LLM æ‰€æœ‰é‡è¯•éƒ½å¤±è´¥æ—¶ï¼Œè‡ªåŠ¨åˆ‡æ¢åˆ°å¤‡ç”¨ LLM</p>
            </div>
            <label class="switch">
              <input type="checkbox" id="llm-useBackupOnFail" checked>
              <span class="slider"></span>
            </label>
          </div>
        </div>
      </section>

      <!-- RSS æº -->
      <section id="sec-rss" class="section">
        <h2 class="section-title">RSS æºç®¡ç†</h2>
        <p class="section-desc">ç®¡ç† <span id="rss-total-count">0</span> ä¸ª RSS è®¢é˜…æº</p>
        
        <!-- æœç´¢å’Œæ‰¹é‡æ“ä½œ -->
        <div class="rss-toolbar">
          <div class="rss-search">
            <input type="text" id="rss-search" placeholder="ğŸ” æœç´¢æ¥æºåç§°æˆ–URL..." oninput="filterRSS()">
          </div>
          <div class="rss-batch-actions">
            <label class="batch-select-all">
              <input type="checkbox" id="rss-select-all" onchange="toggleSelectAll()">
              <span>å…¨é€‰</span>
            </label>
            <button class="btn btn-sm btn-secondary" onclick="batchToggle(true)">âœ“ æ‰¹é‡å¯ç”¨</button>
            <button class="btn btn-sm btn-secondary" onclick="batchToggle(false)">âœ— æ‰¹é‡ç¦ç”¨</button>
            <button class="btn btn-sm btn-danger" onclick="batchDelete()">ğŸ—‘ æ‰¹é‡åˆ é™¤</button>
          </div>
        </div>
        
        <!-- æ·»åŠ æ–°RSS -->
        <div class="add-rss-form">
          <input type="text" id="new-rss-source" placeholder="æ¥æºåç§°">
          <input type="text" id="new-rss-url" placeholder="RSS URL">
          <button class="btn btn-primary" onclick="addRSS()">â• æ·»åŠ </button>
        </div>
        
        <!-- RSSåˆ—è¡¨ï¼ˆå¸¦åˆ†é¡µï¼‰ -->
        <div class="rss-list" id="rss-list"></div>
        
        <!-- åˆ†é¡µæ§åˆ¶ -->
        <div class="rss-pagination" id="rss-pagination"></div>
        
        <div class="action-bar">
          <button class="btn btn-primary" onclick="saveRSS()">ğŸ’¾ ä¿å­˜ RSS</button>
          <span class="rss-status" id="rss-status"></span>
        </div>
      </section>

      <!-- æ‘˜è¦è®¾ç½® -->
      <section id="sec-digest" class="section">
        <h2 class="section-title">æ‘˜è¦è®¾ç½®</h2>
        <p class="section-desc">é…ç½®æ–‡ç« ç­›é€‰å’Œæ‘˜è¦ç”Ÿæˆå‚æ•°</p>
        <div class="card">
          <div class="card-header">
            <div class="card-title">ğŸ“ ç­›é€‰å‚æ•°</div>
            <div class="card-header-actions">
              <button class="btn btn-primary btn-sm" onclick="saveConfig()">ğŸ’¾ ä¿å­˜</button>
            </div>
          </div>
          <div class="form-group">
            <label>æŠ“å–æ—¶é—´èŒƒå›´ï¼ˆå°æ—¶ï¼‰</label>
            <input type="number" id="rss-hours" value="48" min="1" max="168">
          </div>
          <div class="form-group">
            <label>æœ€å¤§æ¨é€æ–‡ç« æ•°</label>
            <input type="number" id="rss-topN" value="15" min="1" max="50">
            <small class="hint">æ¯æ¬¡è¿è¡Œæœ€å¤šæ¨é€çš„é«˜åˆ†æ–‡ç« æ•°é‡ï¼ˆå®é™…è¯„åˆ†æ–‡ç« æ•°ä¸ºæ­¤å€¼çš„2å€ï¼‰</small>
          </div>
          <div class="form-group">
            <label>è¾“å‡ºè¯­è¨€</label>
            <select id="rss-language">
              <option value="zh">ä¸­æ–‡</option>
              <option value="en">English</option>
            </select>
          </div>
        </div>
      </section>

      <!-- Telegram -->
      <section id="sec-telegram" class="section">
        <h2 class="section-title">Telegram æ¨é€</h2>
        <p class="section-desc">é…ç½® Telegram Bot è¿›è¡Œæ¶ˆæ¯æ¨é€</p>
        <div class="card">
          <div class="card-header">
            <div class="card-title">ğŸ“± Bot é…ç½®</div>
            <div class="card-header-actions">
              <button class="btn btn-secondary btn-sm" onclick="testTelegram()">ğŸ“¤ æµ‹è¯•</button>
              <button class="btn btn-primary btn-sm" onclick="saveConfig()">ğŸ’¾ ä¿å­˜</button>
            </div>
          </div>
          <div class="switch-row" style="padding-top:0">
            <div class="switch-info">
              <h4>å¯ç”¨ Telegram æ¨é€</h4>
              <p>å¼€å¯åå°†è‡ªåŠ¨æ¨é€æ‘˜è¦åˆ° Telegram</p>
            </div>
            <label class="switch">
              <input type="checkbox" id="telegram-enabled">
              <span class="slider"></span>
            </label>
          </div>
          <div class="form-group" style="margin-top:16px">
            <label>Bot Token</label>
            <input type="password" id="telegram-botToken" placeholder="ä» @BotFather è·å–">
          </div>
          <div class="form-group">
            <label>Chat ID</label>
            <input type="text" id="telegram-chatId" placeholder="ç”¨æˆ·æˆ–ç¾¤ç»„ ID">
          </div>
          <div class="form-group">
            <label>æ¯æ¬¡æ¨é€æ•°é‡</label>
            <input type="number" id="telegram-pushCount" value="10" min="1" max="30">
          </div>
        </div>
        
        <div class="card">
          <div class="card-header">
            <div class="card-title">ğŸ”— Webhook è®¾ç½®</div>
            <div class="card-header-actions">
              <button class="btn btn-success btn-sm" onclick="autoSetWebhook()">ğŸš€ ä¸€é”®è®¾ç½®</button>
              <button class="btn btn-secondary btn-sm" onclick="checkWebhook()">ğŸ” æ£€æŸ¥</button>
            </div>
          </div>
          <p class="hint" style="margin-bottom:16px">è®¾ç½® Webhook åï¼Œç‚¹å‡»æ¶ˆæ¯æŒ‰é’®æ‰èƒ½æ­£å¸¸å“åº”ï¼ˆå¦‚"é˜…è¯»ä¸­æ–‡å…¨æ–‡"ï¼‰</p>
          <div class="form-group">
            <label>Webhook URL</label>
            <div class="form-row" style="align-items:center">
              <input type="text" id="telegram-webhookUrl" placeholder="https://your-domain.com/webhook/telegram" style="flex:1">
              <button class="btn btn-secondary btn-sm" onclick="autoFillWebhook()" style="white-space:nowrap">ğŸ“ è‡ªåŠ¨å¡«å……</button>
            </div>
            <small class="hint">ç‚¹å‡»"è‡ªåŠ¨å¡«å……"ä½¿ç”¨å½“å‰è®¿é—®åœ°å€ï¼Œæˆ–æ‰‹åŠ¨è¾“å…¥ä½ çš„å…¬ç½‘åœ°å€</small>
          </div>
          <div id="webhook-status" class="hint" style="margin-bottom:12px"></div>
          <div class="card-actions" style="border-top:none;margin-top:0;padding-top:0">
            <button class="btn btn-primary btn-sm" onclick="setWebhook()">ğŸ”— æ‰‹åŠ¨è®¾ç½®</button>
            <button class="btn btn-danger btn-sm" onclick="deleteWebhook()">ğŸ—‘ï¸ åˆ é™¤</button>
          </div>
        </div>
      </section>

      <!-- å®šæ—¶ä»»åŠ¡ -->
      <section id="sec-schedule" class="section">
        <h2 class="section-title">å®šæ—¶ä»»åŠ¡</h2>
        <p class="section-desc">è®¾ç½®è‡ªåŠ¨è¿è¡Œæ—¶é—´</p>
        <div class="card">
          <div class="card-header">
            <div class="card-title">â° å®šæ—¶é…ç½®</div>
            <div class="card-header-actions">
              <button class="btn btn-primary btn-sm" onclick="saveConfig()">ğŸ’¾ ä¿å­˜</button>
            </div>
          </div>
          <div class="switch-row" style="padding-top:0">
            <div class="switch-info">
              <h4>å¯ç”¨å®šæ—¶ä»»åŠ¡</h4>
              <p>æŒ‰è®¾å®šæ—¶é—´è‡ªåŠ¨æŠ“å–å’Œæ¨é€</p>
            </div>
            <label class="switch">
              <input type="checkbox" id="schedule-enabled">
              <span class="slider"></span>
            </label>
          </div>
          <div class="form-group" style="margin-top:16px">
            <label>Cron è¡¨è¾¾å¼ï¼ˆåˆ† æ—¶ * * *ï¼‰</label>
            <input type="text" id="schedule-cron" placeholder="0 8 * * *">
            <small class="hint">ç¤ºä¾‹ï¼š0 8 * * * = æ¯å¤©æ—©ä¸Š8ç‚¹</small>
          </div>
        </div>
      </section>

      <!-- è¿è¡Œå†å² -->
      <section id="sec-history" class="section">
        <div class="card-header" style="margin-bottom:16px">
          <div>
            <h2 class="section-title" style="margin-bottom:4px">è¿è¡Œå†å²</h2>
            <p class="section-desc" style="margin-bottom:0">æŸ¥çœ‹æœ€è¿‘çš„è¿è¡Œè®°å½•</p>
          </div>
          <div class="card-header-actions">
            <button class="btn btn-secondary btn-sm" onclick="loadHistory()">ğŸ”„ åˆ·æ–°</button>
            <button class="btn btn-success btn-sm" onclick="runDigest()">â–¶ï¸ ç«‹å³è¿è¡Œ</button>
          </div>
        </div>
        <div class="card" id="history-container">
          <p class="hint">åŠ è½½ä¸­...</p>
        </div>
      </section>

      <!-- ç³»ç»Ÿæ—¥å¿— -->
      <section id="sec-logs" class="section">
        <div class="card-header" style="margin-bottom:16px">
          <div>
            <h2 class="section-title" style="margin-bottom:4px">ç³»ç»Ÿæ—¥å¿—</h2>
            <p class="section-desc" style="margin:0">æŸ¥çœ‹ç³»ç»Ÿè¿è¡Œæ—¥å¿—ï¼Œä¾¿äºæ’æŸ¥é—®é¢˜</p>
          </div>
          <div class="card-header-actions">
            <select id="logLevel" style="padding:6px 10px;border-radius:6px;border:1px solid var(--border-color);background:var(--bg-secondary);color:var(--text-primary);margin-right:8px">
              <option value="all">å…¨éƒ¨çº§åˆ«</option>
              <option value="info">ä¿¡æ¯</option>
              <option value="warn">è­¦å‘Š</option>
              <option value="error">é”™è¯¯</option>
            </select>
            <input type="number" id="logLimit" value="100" min="10" max="500" style="width:70px;padding:6px 10px;border-radius:6px;border:1px solid var(--border-color);background:var(--bg-secondary);color:var(--text-primary);margin-right:8px" title="æ—¥å¿—æ•°é‡">
            <button class="btn btn-primary btn-sm" onclick="loadLogs()">ğŸ”„ åˆ·æ–°</button>
            <button class="btn btn-danger btn-sm" onclick="clearLogs()" style="margin-left:8px">ğŸ—‘ï¸ æ¸…ç©º</button>
          </div>
        </div>
        <div class="card">
          <div id="logsContainer" style="max-height:600px;overflow-y:auto;font-family:monospace;font-size:13px;background:var(--bg-tertiary);border-radius:8px;padding:12px">
            <p style="color:var(--text-secondary)">ç‚¹å‡»ã€Œåˆ·æ–°ã€è·å–æœ€æ–°æ—¥å¿—...</p>
          </div>
        </div>
      </section>

      <!-- è´¦å·è®¾ç½® -->
      <section id="sec-account" class="section">
        <h2 class="section-title">è´¦å·è®¾ç½®</h2>
        <p class="section-desc">ä¿®æ”¹ç®¡ç†å‘˜è´¦å·å’Œå¯†ç </p>
        <div class="card">
          <div class="card-header">
            <div class="card-title">ğŸ” ä¿®æ”¹ç™»å½•å‡­æ®</div>
            <div class="card-header-actions">
              <button class="btn btn-primary btn-sm" onclick="saveAccount()">ğŸ’¾ ä¿å­˜</button>
            </div>
          </div>
          <div class="form-group">
            <label>ç”¨æˆ·å</label>
            <input type="text" id="admin-username" placeholder="admin">
          </div>
          <div class="form-group">
            <label>å½“å‰å¯†ç </label>
            <input type="password" id="admin-current-password" placeholder="è¾“å…¥å½“å‰å¯†ç ä»¥éªŒè¯èº«ä»½">
          </div>
          <div class="form-group">
            <label>æ–°å¯†ç </label>
            <input type="password" id="admin-new-password" placeholder="ç•™ç©ºåˆ™ä¸ä¿®æ”¹å¯†ç ">
          </div>
          <div class="form-group">
            <label>ç¡®è®¤æ–°å¯†ç </label>
            <input type="password" id="admin-confirm-password" placeholder="å†æ¬¡è¾“å…¥æ–°å¯†ç ">
          </div>
          <div class="hint" style="margin-top:12px;padding:10px;background:rgba(255,193,7,0.1);border-radius:6px">
            âš ï¸ ä¿®æ”¹è´¦å·ä¿¡æ¯åéœ€è¦é‡æ–°ç™»å½•ã€‚è¯·ç‰¢è®°æ–°çš„ç”¨æˆ·åå’Œå¯†ç ã€‚
          </div>
        </div>
      </section>
    </main>
    
    <!-- ç¼–è¾‘ RSS æ¨¡æ€æ¡† -->
    <div class="modal-overlay" id="edit-rss-modal" onclick="closeEditModal(event)">
      <div class="modal" onclick="event.stopPropagation()">
        <div class="modal-title">âœï¸ ç¼–è¾‘ RSS æº</div>
        <input type="hidden" id="edit-rss-index">
        <div class="form-group">
          <label>æ¥æºåç§°</label>
          <input type="text" id="edit-rss-source" placeholder="æ¥æºåç§°">
        </div>
        <div class="form-group">
          <label>RSS URL</label>
          <input type="text" id="edit-rss-url" placeholder="RSS URL">
        </div>
        <div class="modal-actions">
          <button class="btn btn-secondary" onclick="closeEditModal()">å–æ¶ˆ</button>
          <button class="btn btn-primary" onclick="saveEditRSS()">ğŸ’¾ ä¿å­˜</button>
        </div>
      </div>
    </div>
  </div>
  <script>
let config = {};
let rssFeeds = [];

// èœå•åˆ‡æ¢
document.querySelectorAll('.nav-item[data-section]').forEach(item => {
  item.addEventListener('click', () => {
    document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
    document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
    item.classList.add('active');
    document.getElementById('sec-' + item.dataset.section).classList.add('active');
    if (item.dataset.section === 'history') loadHistory();
    if (item.dataset.section === 'rss') loadRSS();
    if (item.dataset.section === 'logs') loadLogs();
  });
});

// Toast æç¤º
function toast(msg, type = 'success') {
  const t = document.createElement('div');
  t.className = 'toast ' + type;
  t.textContent = msg;
  document.body.appendChild(t);
  setTimeout(() => t.remove(), 3000);
}

// ç»Ÿä¸€å¤„ç†APIå“åº”
async function handleApiResponse(res) {
  if (res.status === 401) {
    window.location.href = '/login';
    throw new Error('æœªæˆæƒ');
  }
  return res;
}

// åŠ è½½é…ç½®
async function loadConfig() {
  try {
    const res = await handleApiResponse(await fetch('/api/config'));
    config = await res.json();
    
    // ä¸» LLM
    document.getElementById('llm-baseUrl').value = config.llm?.baseUrl || '';
    document.getElementById('llm-apiKey').value = '';  // å¯†ç æ¡†æ¸…ç©ºï¼Œä¸æ˜¾ç¤º ***
    document.getElementById('llm-apiKey-hint').textContent = config.llm?.apiKeyHint || '';
    const modelSelect = document.getElementById('llm-model');
    if (config.llm?.model) {
      modelSelect.innerHTML = '<option value="' + config.llm.model + '">' + config.llm.model + '</option>';
    }
    
    // å¤‡ç”¨ LLM
    document.getElementById('llm-backup-baseUrl').value = config.llmBackup?.baseUrl || '';
    document.getElementById('llm-backup-apiKey').value = '';  // å¯†ç æ¡†æ¸…ç©º
    document.getElementById('llm-backup-apiKey-hint').textContent = config.llmBackup?.apiKeyHint || '';
    const backupModelSelect = document.getElementById('llm-backup-model');
    if (config.llmBackup?.model) {
      backupModelSelect.innerHTML = '<option value="' + config.llmBackup.model + '">' + config.llmBackup.model + '</option>';
    }
    
    // LLM é«˜çº§è®¾ç½®
    document.getElementById('llm-timeout').value = (config.llmSettings?.timeout || 120000) / 1000;
    document.getElementById('llm-maxRetries').value = config.llmSettings?.maxRetries ?? 2;
    document.getElementById('llm-useBackupOnFail').checked = config.llmSettings?.useBackupOnFail ?? true;
    
    // RSS è®¾ç½®
    document.getElementById('rss-hours').value = config.rss?.hours || 48;
    document.getElementById('rss-topN').value = config.rss?.topN || 15;
    document.getElementById('rss-language').value = config.rss?.language || 'zh';
    
    // Telegram è®¾ç½®
    document.getElementById('telegram-enabled').checked = config.telegram?.enabled || false;
    document.getElementById('telegram-botToken').value = config.telegram?.botToken || '';
    document.getElementById('telegram-chatId').value = config.telegram?.chatId || '';
    document.getElementById('telegram-pushCount').value = config.telegram?.pushCount || 10;
    
    // å®šæ—¶ä»»åŠ¡
    document.getElementById('schedule-enabled').checked = config.schedule?.enabled || false;
    document.getElementById('schedule-cron').value = config.schedule?.cron || '0 8 * * *';
  } catch (e) {
    toast('åŠ è½½é…ç½®å¤±è´¥', 'error');
  }
}

// ä¿å­˜é…ç½®
async function saveConfig() {
  const newConfig = {
    llm: {
      baseUrl: document.getElementById('llm-baseUrl').value,
      apiKey: document.getElementById('llm-apiKey').value,
      model: document.getElementById('llm-model').value,
    },
    llmBackup: {
      baseUrl: document.getElementById('llm-backup-baseUrl').value,
      apiKey: document.getElementById('llm-backup-apiKey').value,
      model: document.getElementById('llm-backup-model').value,
    },
    llmSettings: {
      timeout: parseInt(document.getElementById('llm-timeout').value) * 1000,
      maxRetries: parseInt(document.getElementById('llm-maxRetries').value),
      useBackupOnFail: document.getElementById('llm-useBackupOnFail').checked,
    },
    rss: {
      hours: parseInt(document.getElementById('rss-hours').value),
      topN: parseInt(document.getElementById('rss-topN').value),
      language: document.getElementById('rss-language').value,
    },
    telegram: {
      enabled: document.getElementById('telegram-enabled').checked,
      botToken: document.getElementById('telegram-botToken').value,
      chatId: document.getElementById('telegram-chatId').value,
      pushCount: parseInt(document.getElementById('telegram-pushCount').value),
    },
    schedule: {
      enabled: document.getElementById('schedule-enabled').checked,
      cron: document.getElementById('schedule-cron').value,
    },
  };
  try {
    const res = await fetch('/api/config', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(newConfig),
    });
    if (res.ok) toast('ä¿å­˜æˆåŠŸ');
    else toast('ä¿å­˜å¤±è´¥', 'error');
  } catch (e) {
    toast('ä¿å­˜å¤±è´¥', 'error');
  }
}

// è·å–æ¨¡å‹åˆ—è¡¨
async function fetchModels(type = 'primary') {
  const btn = event.target;
  btn.disabled = true;
  btn.textContent = 'è·å–ä¸­...';
  
  const isBackup = type === 'backup';
  const baseUrlId = isBackup ? 'llm-backup-baseUrl' : 'llm-baseUrl';
  const apiKeyId = isBackup ? 'llm-backup-apiKey' : 'llm-apiKey';
  const modelSelectId = isBackup ? 'llm-backup-model' : 'llm-model';
  
  try {
    const baseUrl = document.getElementById(baseUrlId).value;
    const apiKey = document.getElementById(apiKeyId).value;
    
    // å…è®¸ä¸å¡«å†™ï¼Œåç«¯ä¼šä½¿ç”¨å·²ä¿å­˜çš„é…ç½®
    const res = await fetch('/api/llm/models', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ baseUrl, apiKey, type }),
    });
    const data = await res.json();
    
    if (data.error) {
      toast(data.error, 'error');
    } else if (data.models?.length) {
      const select = document.getElementById(modelSelectId);
      const current = select.value;
      select.innerHTML = data.models.map(m =>
        '<option value="' + m + '"' + (m === current ? ' selected' : '') + '>' + m + '</option>'
      ).join('');
      toast('è·å–åˆ° ' + data.models.length + ' ä¸ªæ¨¡å‹');
    } else {
      toast('æœªæ‰¾åˆ°æ¨¡å‹', 'error');
    }
  } catch (e) {
    toast('è·å–å¤±è´¥', 'error');
  }
  btn.disabled = false;
  btn.textContent = 'ğŸ”„ è·å–æ¨¡å‹';
}

// å•ç‹¬ä¿å­˜ LLM é…ç½®
async function saveLLM(type) {
  const btn = event.target;
  btn.disabled = true;
  const originalText = btn.textContent;
  btn.textContent = 'ä¿å­˜ä¸­...';
  
  try {
    const isBackup = type === 'backup';
    const prefix = isBackup ? 'llm-backup-' : 'llm-';
    
    const llmConfig = {
      baseUrl: document.getElementById(prefix + 'baseUrl').value,
      apiKey: document.getElementById(prefix + 'apiKey').value,
      model: document.getElementById(prefix + (isBackup ? 'model' : 'model')).value,
    };
    
    // åªæ›´æ–°å¯¹åº”çš„ LLM é…ç½®
    const updateData = isBackup ? { llmBackup: llmConfig } : { llm: llmConfig };
    
    const res = await fetch('/api/config', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(updateData),
    });
    
    if (res.ok) {
      toast(isBackup ? 'âœ… å¤‡ç”¨ LLM å·²ä¿å­˜' : 'âœ… ä¸» LLM å·²ä¿å­˜');
      // é‡æ–°åŠ è½½é…ç½®ä»¥æ›´æ–°æç¤º
      await loadConfig();
    } else {
      toast('ä¿å­˜å¤±è´¥', 'error');
    }
  } catch (e) {
    toast('ä¿å­˜å¤±è´¥', 'error');
  }
  
  btn.disabled = false;
  btn.textContent = originalText;
}

// å•ç‹¬æµ‹è¯• LLM è¿æ¥
async function testSingleLLM(type) {
  const btn = event.target;
  btn.disabled = true;
  const originalText = btn.textContent;
  btn.textContent = 'æµ‹è¯•ä¸­...';
  
  try {
    const isBackup = type === 'backup';
    const prefix = isBackup ? 'llm-backup-' : 'llm-';
    
    const baseUrl = document.getElementById(prefix + 'baseUrl').value;
    const apiKey = document.getElementById(prefix + 'apiKey').value;
    const model = document.getElementById(prefix + 'model').value;
    
    // å…è®¸ä¸å¡«å†™ï¼Œåç«¯ä¼šä½¿ç”¨å·²ä¿å­˜çš„é…ç½®
    
    const res = await fetch('/api/llm/test-single', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ baseUrl, apiKey, model, type }),
    });
    const data = await res.json();
    
    if (data.success) {
      toast('âœ… è¿æ¥æˆåŠŸ');
    } else {
      toast('âŒ ' + (data.error || 'è¿æ¥å¤±è´¥'), 'error');
    }
  } catch (e) {
    toast('æµ‹è¯•å¤±è´¥', 'error');
  }
  
  btn.disabled = false;
  btn.textContent = originalText;
}

// æµ‹è¯•æ‰€æœ‰ LLM è¿æ¥
async function testLLM() {
  const btn = event.target;
  btn.disabled = true;
  btn.textContent = 'æµ‹è¯•ä¸­...';
  
  try {
    await saveConfig();
    const res = await fetch('/api/llm/test', { method: 'POST' });
    const data = await res.json();
    
    if (data.success) {
      let msg = 'âœ… ä¸» LLM è¿æ¥æˆåŠŸ';
      if (data.backupTested) {
        msg += data.backupSuccess ? '\nâœ… å¤‡ç”¨ LLM è¿æ¥æˆåŠŸ' : '\nâŒ å¤‡ç”¨ LLM è¿æ¥å¤±è´¥';
      }
      toast(msg);
    } else {
      toast('âŒ ' + (data.message || 'è¿æ¥å¤±è´¥'), 'error');
    }
  } catch (e) {
    toast('æµ‹è¯•å¤±è´¥', 'error');
  }
  
  btn.disabled = false;
  btn.textContent = 'ğŸ§ª æµ‹è¯•è¿æ¥';
}

// RSS ç®¡ç† - åˆ†é¡µå’Œæ‰¹é‡æ“ä½œ
let rssPage = 1;
const RSS_PER_PAGE = 20;
let rssSearchTerm = '';
let rssSelected = new Set();

async function loadRSS() {
  try {
    const res = await fetch('/api/rss');
    rssFeeds = await res.json();
    rssSelected.clear();
    rssPage = 1;
    rssSearchTerm = '';
    document.getElementById('rss-search').value = '';
    document.getElementById('rss-select-all').checked = false;
    renderRSS();
  } catch (e) {
    toast('åŠ è½½ RSS å¤±è´¥', 'error');
  }
}

function getFilteredRSS() {
  if (!rssSearchTerm) return rssFeeds;
  const term = rssSearchTerm.toLowerCase();
  return rssFeeds.filter(f => 
    f.source.toLowerCase().includes(term) || 
    f.url.toLowerCase().includes(term)
  );
}

function renderRSS() {
  const filtered = getFilteredRSS();
  const total = filtered.length;
  const totalPages = Math.ceil(total / RSS_PER_PAGE) || 1;
  
  // ç¡®ä¿é¡µç æœ‰æ•ˆ
  if (rssPage > totalPages) rssPage = totalPages;
  if (rssPage < 1) rssPage = 1;
  
  const start = (rssPage - 1) * RSS_PER_PAGE;
  const pageItems = filtered.slice(start, start + RSS_PER_PAGE);
  
  // æ›´æ–°ç»Ÿè®¡
  document.getElementById('rss-total-count').textContent = rssFeeds.length;
  const enabledCount = rssFeeds.filter(f => f.enabled).length;
  document.getElementById('rss-status').textContent = 
    `å·²å¯ç”¨ ${enabledCount}/${rssFeeds.length}` + 
    (rssSearchTerm ? ` | æœç´¢ç»“æœ ${total} æ¡` : '');
  
  // æ¸²æŸ“åˆ—è¡¨
  const container = document.getElementById('rss-list');
  if (!pageItems.length) {
    container.innerHTML = '<div style="padding:20px;text-align:center;color:var(--text-secondary)">' +
      (rssSearchTerm ? 'æ²¡æœ‰åŒ¹é…çš„ RSS æº' : 'æš‚æ—  RSS æº') + '</div>';
  } else {
    container.innerHTML = pageItems.map((feed, i) => {
      const realIndex = rssFeeds.indexOf(feed);
      const isSelected = rssSelected.has(realIndex);
      return `
        <div class="rss-item ${isSelected ? 'selected' : ''}" data-index="${realIndex}">
          <input type="checkbox" class="rss-checkbox" ${isSelected ? 'checked' : ''} 
            onchange="toggleSelect(${realIndex})">
          <label class="switch">
            <input type="checkbox" ${feed.enabled ? 'checked' : ''} onchange="toggleRSS(${realIndex})">
            <span class="slider"></span>
          </label>
          <div class="rss-info">
            <div class="source">${escapeHtml(feed.source)}</div>
            <div class="url" title="${escapeHtml(feed.url)}">${escapeHtml(feed.url)}</div>
          </div>
          <div class="rss-actions">
            <button class="btn btn-secondary btn-sm" onclick="editRSS(${realIndex})">âœï¸</button>
            <button class="btn btn-danger btn-sm" onclick="deleteRSS(${realIndex})">ğŸ—‘ï¸</button>
          </div>
        </div>
      `;
    }).join('');
  }
  
  // æ¸²æŸ“åˆ†é¡µ
  renderPagination(totalPages);
  
  // æ›´æ–°å…¨é€‰çŠ¶æ€
  updateSelectAllState();
}

function escapeHtml(str) {
  return str.replace(/&/g,'&').replace(/</g,'<').replace(/>/g,'>').replace(/"/g,'"');
}

function renderPagination(totalPages) {
  const container = document.getElementById('rss-pagination');
  if (totalPages <= 1) {
    container.innerHTML = '';
    return;
  }
  
  let html = `<button onclick="goToPage(1)" ${rssPage === 1 ? 'disabled' : ''}>é¦–é¡µ</button>`;
  html += `<button onclick="goToPage(${rssPage - 1})" ${rssPage === 1 ? 'disabled' : ''}>ä¸Šä¸€é¡µ</button>`;
  
  // æ˜¾ç¤ºé¡µç 
  const maxVisible = 5;
  let startPage = Math.max(1, rssPage - Math.floor(maxVisible / 2));
  let endPage = Math.min(totalPages, startPage + maxVisible - 1);
  if (endPage - startPage < maxVisible - 1) {
    startPage = Math.max(1, endPage - maxVisible + 1);
  }
  
  for (let p = startPage; p <= endPage; p++) {
    html += `<button onclick="goToPage(${p})" class="${p === rssPage ? 'active' : ''}">${p}</button>`;
  }
  
  html += `<button onclick="goToPage(${rssPage + 1})" ${rssPage === totalPages ? 'disabled' : ''}>ä¸‹ä¸€é¡µ</button>`;
  html += `<button onclick="goToPage(${totalPages})" ${rssPage === totalPages ? 'disabled' : ''}>æœ«é¡µ</button>`;
  html += `<span class="page-info">ç¬¬ ${rssPage}/${totalPages} é¡µ</span>`;
  
  container.innerHTML = html;
}

function goToPage(page) {
  rssPage = page;
  renderRSS();
}

function filterRSS() {
  rssSearchTerm = document.getElementById('rss-search').value.trim();
  rssPage = 1;
  rssSelected.clear();
  document.getElementById('rss-select-all').checked = false;
  renderRSS();
}

function toggleSelect(index) {
  if (rssSelected.has(index)) {
    rssSelected.delete(index);
  } else {
    rssSelected.add(index);
  }
  updateSelectAllState();
  renderRSS();
}

function toggleSelectAll() {
  const checked = document.getElementById('rss-select-all').checked;
  const pageItems = getCurrentPageItems();
  
  if (checked) {
    // åªé€‰ä¸­å½“å‰é¡µé¢çš„é¡¹
    pageItems.forEach(feed => {
      const index = rssFeeds.indexOf(feed);
      rssSelected.add(index);
    });
  } else {
    // åªå–æ¶ˆé€‰ä¸­å½“å‰é¡µé¢çš„é¡¹
    pageItems.forEach(feed => {
      const index = rssFeeds.indexOf(feed);
      rssSelected.delete(index);
    });
  }
  renderRSS();
}

function getCurrentPageItems() {
  const filtered = getFilteredRSS();
  const start = (rssPage - 1) * RSS_PER_PAGE;
  return filtered.slice(start, start + RSS_PER_PAGE);
}

function updateSelectAllState() {
  const pageItems = getCurrentPageItems();
  const allSelected = pageItems.length > 0 && pageItems.every(feed => rssSelected.has(rssFeeds.indexOf(feed)));
  document.getElementById('rss-select-all').checked = allSelected;
}

function toggleRSS(index) {
  rssFeeds[index].enabled = !rssFeeds[index].enabled;
  renderRSS();
}

function deleteRSS(index) {
  rssFeeds.splice(index, 1);
  rssSelected.delete(index);
  // æ›´æ–°é€‰ä¸­ç´¢å¼•ï¼ˆåˆ é™¤åç´¢å¼•å¯èƒ½å˜åŒ–ï¼‰
  const newSelected = new Set();
  rssSelected.forEach(i => {
    if (i < index) newSelected.add(i);
    else if (i > index) newSelected.add(i - 1);
  });
  rssSelected = newSelected;
  renderRSS();
}

function editRSS(index) {
  const feed = rssFeeds[index];
  document.getElementById('edit-rss-index').value = index;
  document.getElementById('edit-rss-source').value = feed.source;
  document.getElementById('edit-rss-url').value = feed.url;
  document.getElementById('edit-rss-modal').classList.add('active');
}

function closeEditModal(event) {
  if (event && event.target !== event.currentTarget) return;
  document.getElementById('edit-rss-modal').classList.remove('active');
}

function saveEditRSS() {
  const index = parseInt(document.getElementById('edit-rss-index').value);
  const source = document.getElementById('edit-rss-source').value.trim();
  const url = document.getElementById('edit-rss-url').value.trim();
  
  if (!source || !url) {
    toast('è¯·å¡«å†™æ¥æºåç§°å’Œ URL', 'error');
    return;
  }
  
  rssFeeds[index].source = source;
  rssFeeds[index].url = url;
  closeEditModal();
  renderRSS();
  toast('å·²æ›´æ–° RSS æº');
}

function addRSS() {
  const source = document.getElementById('new-rss-source').value.trim();
  const url = document.getElementById('new-rss-url').value.trim();
  if (!source || !url) {
    toast('è¯·å¡«å†™æ¥æºåç§°å’Œ URL', 'error');
    return;
  }
  rssFeeds.unshift({ source, url, enabled: true }); // æ·»åŠ åˆ°å¼€å¤´
  rssPage = 1;
  rssSearchTerm = '';
  document.getElementById('rss-search').value = '';
  renderRSS();
  document.getElementById('new-rss-source').value = '';
  document.getElementById('new-rss-url').value = '';
  toast('å·²æ·»åŠ  RSS æº');
}

// æ‰¹é‡æ“ä½œ
function batchToggle(enable) {
  if (rssSelected.size === 0) {
    toast('è¯·å…ˆé€‰æ‹©è¦æ“ä½œçš„ RSS æº', 'error');
    return;
  }
  rssSelected.forEach(index => {
    rssFeeds[index].enabled = enable;
  });
  renderRSS();
  toast(`å·²${enable ? 'å¯ç”¨' : 'ç¦ç”¨'} ${rssSelected.size} ä¸ª RSS æº`);
}

function batchDelete() {
  if (rssSelected.size === 0) {
    toast('è¯·å…ˆé€‰æ‹©è¦åˆ é™¤çš„ RSS æº', 'error');
    return;
  }
  if (!confirm(`ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ ${rssSelected.size} ä¸ª RSS æºå—ï¼Ÿ`)) return;
  
  // ä»å¤§åˆ°å°æ’åºç´¢å¼•ï¼Œé¿å…åˆ é™¤æ—¶ç´¢å¼•é”™ä½
  const indices = Array.from(rssSelected).sort((a, b) => b - a);
  indices.forEach(index => {
    rssFeeds.splice(index, 1);
  });
  rssSelected.clear();
  renderRSS();
  toast(`å·²åˆ é™¤ ${indices.length} ä¸ª RSS æº`);
}

async function saveRSS() {
  try {
    const res = await fetch('/api/rss', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(rssFeeds),
    });
    if (res.ok) toast('RSS ä¿å­˜æˆåŠŸ');
    else toast('ä¿å­˜å¤±è´¥', 'error');
  } catch (e) {
    toast('ä¿å­˜å¤±è´¥', 'error');
  }
}

// è¿è¡Œ
async function runDigest() {
  const btn = event.target;
  btn.disabled = true;
  btn.textContent = 'è¿è¡Œä¸­...';
  try {
    const res = await fetch('/api/run', { method: 'POST' });
    const data = await res.json();
    toast(data.message);
  } catch (e) {
    toast('è¿è¡Œå¤±è´¥', 'error');
  }
  btn.disabled = false;
  btn.textContent = 'â–¶ï¸ ç«‹å³è¿è¡Œ';
}

// å†å²
async function loadHistory() {
  try {
    const res = await fetch('/api/history');
    const history = await res.json();
    const container = document.getElementById('history-container');
    if (!history.length) {
      container.innerHTML = '<p class="hint">æš‚æ— è¿è¡Œè®°å½•</p>';
      return;
    }
    container.innerHTML = history.slice(0, 10).map(h => `
      <div class="history-item">
        <div class="history-header">
          <span class="history-date">${h.date}</span>
          <span class="badge badge-success">${h.count} ç¯‡</span>
        </div>
        <ul class="history-articles">
          ${(h.articles || []).slice(0, 5).map(a => '<li>' + a.title + ' (' + a.score + 'åˆ†)</li>').join('')}
        </ul>
      </div>
    `).join('');
  } catch (e) {
    toast('åŠ è½½å†å²å¤±è´¥', 'error');
  }
}

// Telegram æµ‹è¯•
async function testTelegram() {
  const btn = event.target;
  btn.disabled = true;
  btn.textContent = 'å‘é€ä¸­...';
  
  try {
    await saveConfig();
    const res = await fetch('/api/telegram/test', { method: 'POST' });
    const data = await res.json();
    
    if (data.success) {
      toast('âœ… æµ‹è¯•æ¶ˆæ¯å·²å‘é€ï¼Œè¯·æ£€æŸ¥ Telegram');
    } else {
      toast('âŒ ' + (data.message || 'å‘é€å¤±è´¥'), 'error');
    }
  } catch (e) {
    toast('å‘é€å¤±è´¥', 'error');
  }
  
  btn.disabled = false;
  btn.textContent = 'ğŸ“¤ æµ‹è¯•æ¨é€';
}

// Webhook ç®¡ç†
function autoFillWebhook() {
  const currentUrl = window.location.origin;
  const webhookUrl = currentUrl + '/webhook/telegram';
  document.getElementById('telegram-webhookUrl').value = webhookUrl;
  toast('å·²è‡ªåŠ¨å¡«å…… Webhook URL');
}

async function autoSetWebhook() {
  // å…ˆè‡ªåŠ¨å¡«å……
  autoFillWebhook();
  // ç„¶åè®¾ç½®
  await setWebhook();
}

async function checkWebhook() {
  const statusDiv = document.getElementById('webhook-status');
  statusDiv.textContent = 'æ£€æŸ¥ä¸­...';
  
  try {
    const res = await fetch('/api/telegram/webhook');
    const data = await res.json();
    
    if (data.success) {
      if (data.url) {
        statusDiv.innerHTML = `âœ… å·²è®¾ç½®: <code>${data.url}</code>` + 
          (data.lastErrorMessage ? `<br>âš ï¸ æœ€è¿‘é”™è¯¯: ${data.lastErrorMessage}` : '');
        document.getElementById('telegram-webhookUrl').value = data.url;
      } else {
        statusDiv.textContent = 'âš ï¸ æœªè®¾ç½® Webhook';
      }
    } else {
      statusDiv.textContent = 'âŒ ' + (data.message || 'æ£€æŸ¥å¤±è´¥');
    }
  } catch (e) {
    statusDiv.textContent = 'âŒ æ£€æŸ¥å¤±è´¥';
  }
}

async function setWebhook() {
  const webhookUrl = document.getElementById('telegram-webhookUrl').value.trim();
  if (!webhookUrl) {
    toast('è¯·è¾“å…¥ Webhook URL', 'error');
    return;
  }
  
  const statusDiv = document.getElementById('webhook-status');
  statusDiv.textContent = 'è®¾ç½®ä¸­...';
  
  try {
    const res = await fetch('/api/telegram/webhook', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ webhookUrl }),
    });
    const data = await res.json();
    
    if (data.success) {
      toast('âœ… ' + data.message);
      statusDiv.textContent = 'âœ… Webhook è®¾ç½®æˆåŠŸ';
    } else {
      toast('âŒ ' + (data.message || 'è®¾ç½®å¤±è´¥'), 'error');
      statusDiv.textContent = 'âŒ ' + (data.message || 'è®¾ç½®å¤±è´¥');
    }
  } catch (e) {
    toast('è®¾ç½®å¤±è´¥', 'error');
    statusDiv.textContent = 'âŒ è®¾ç½®å¤±è´¥';
  }
}

async function deleteWebhook() {
  const statusDiv = document.getElementById('webhook-status');
  statusDiv.textContent = 'åˆ é™¤ä¸­...';
  
  try {
    const res = await fetch('/api/telegram/webhook', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ webhookUrl: '' }),
    });
    const data = await res.json();
    
    if (data.success) {
      toast('âœ… ' + data.message);
      statusDiv.textContent = 'âš ï¸ Webhook å·²åˆ é™¤';
      document.getElementById('telegram-webhookUrl').value = '';
    } else {
      toast('âŒ ' + (data.message || 'åˆ é™¤å¤±è´¥'), 'error');
      statusDiv.textContent = 'âŒ ' + (data.message || 'åˆ é™¤å¤±è´¥');
    }
  } catch (e) {
    toast('åˆ é™¤å¤±è´¥', 'error');
    statusDiv.textContent = 'âŒ åˆ é™¤å¤±è´¥';
  }
}

// è´¦å·ç®¡ç†
async function loadAccount() {
  try {
    const res = await fetch('/api/admin/account');
    if (res.ok) {
      const data = await res.json();
      document.getElementById('admin-username').value = data.username || '';
    }
  } catch (e) {
    console.error('åŠ è½½è´¦å·ä¿¡æ¯å¤±è´¥', e);
  }
}

async function saveAccount() {
  const username = document.getElementById('admin-username').value.trim();
  const currentPassword = document.getElementById('admin-current-password').value;
  const newPassword = document.getElementById('admin-new-password').value;
  const confirmPassword = document.getElementById('admin-confirm-password').value;

  if (!username) {
    toast('ç”¨æˆ·åä¸èƒ½ä¸ºç©º', 'error');
    return;
  }

  if (!currentPassword) {
    toast('è¯·è¾“å…¥å½“å‰å¯†ç ä»¥éªŒè¯èº«ä»½', 'error');
    return;
  }

  if (newPassword && newPassword !== confirmPassword) {
    toast('ä¸¤æ¬¡è¾“å…¥çš„æ–°å¯†ç ä¸ä¸€è‡´', 'error');
    return;
  }

  if (newPassword && newPassword.length < 6) {
    toast('æ–°å¯†ç é•¿åº¦è‡³å°‘6ä½', 'error');
    return;
  }

  try {
    const res = await fetch('/api/admin/account', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        username,
        currentPassword,
        newPassword: newPassword || undefined,
      }),
    });
    const data = await res.json();
    
    if (data.success) {
      toast('è´¦å·ä¿¡æ¯å·²æ›´æ–°ï¼Œè¯·é‡æ–°ç™»å½•');
      document.getElementById('admin-current-password').value = '';
      document.getElementById('admin-new-password').value = '';
      document.getElementById('admin-confirm-password').value = '';
      setTimeout(() => {
        document.cookie = 'token=; path=/; max-age=0';
        window.location.href = '/login';
      }, 1500);
    } else {
      toast(data.message || 'ä¿å­˜å¤±è´¥', 'error');
    }
  } catch (e) {
    toast('ä¿å­˜å¤±è´¥', 'error');
  }
}

// é€€å‡ºç™»å½•
async function logout() {
  if (confirm('ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ')) {
    try {
      await fetch('/api/logout', { method: 'POST' });
    } catch (e) {}
    document.cookie = 'token=; path=/; max-age=0';
    window.location.href = '/login';
  }
}

// ==================== æ—¥å¿—åŠŸèƒ½ ====================
async function loadLogs() {
  const container = document.getElementById('logsContainer');
  const level = document.getElementById('logLevel').value;
  const limit = document.getElementById('logLimit').value || 100;
  
  container.innerHTML = '<p style="color:var(--text-secondary)">åŠ è½½ä¸­...</p>';
  
  try {
    const params = new URLSearchParams({ limit });
    if (level !== 'all') params.append('level', level);
    
    const res = await fetch('/api/logs?' + params.toString());
    if (!res.ok) throw new Error('è·å–æ—¥å¿—å¤±è´¥');
    
    const logs = await res.json();
    
    if (logs.length === 0) {
      container.innerHTML = '<p style="color:var(--text-secondary)">æš‚æ— æ—¥å¿—</p>';
      return;
    }
    
    const levelColors = {
      info: '#4ade80',
      warn: '#facc15', 
      error: '#f87171'
    };
    
    container.innerHTML = logs.map(log => {
      const time = new Date(log.time).toLocaleString('zh-CN');
      const color = levelColors[log.level] || '#9ca3af';
      const levelTag = `<span style="color:${color};font-weight:bold">[${log.level.toUpperCase()}]</span>`;
      return `<div style="padding:4px 0;border-bottom:1px solid var(--border-color)">
        <span style="color:var(--text-secondary)">${time}</span> ${levelTag} ${escapeHtml(log.message)}
      </div>`;
    }).join('');
    
  } catch (e) {
    container.innerHTML = `<p style="color:var(--danger)">âŒ ${e.message}</p>`;
  }
}

async function clearLogs() {
  if (!confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æ—¥å¿—å—ï¼Ÿ')) return;
  
  try {
    const res = await fetch('/api/logs/clear', { method: 'POST' });
    if (!res.ok) throw new Error('æ¸…ç©ºå¤±è´¥');
    
    document.getElementById('logsContainer').innerHTML = '<p style="color:var(--text-secondary)">æ—¥å¿—å·²æ¸…ç©º</p>';
    alert('âœ… æ—¥å¿—å·²æ¸…ç©º');
  } catch (e) {
    alert('âŒ ' + e.message);
  }
}

function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

// åˆå§‹åŒ–
loadConfig();
loadRSS();
loadAccount();
  </script>
</body>
</html>
